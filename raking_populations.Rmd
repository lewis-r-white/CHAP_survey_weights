---
title: "Raking Larger Model"
author: "Lewis White"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libraries
```{r}
library(tidyverse)
library(survey)
```

## Set working directory 
```{r}
setwd("/Users/lewiswhite/CHAP_columbia/survey_weights")
```

## Loading in the data
```{r}
#includes the weights from Linnea and Flavio's V4 weights 
GL_EA_weights <- read_csv("weight_2010_full_results.csv")

#responses to the survey
demographics <- read_csv("Demographics dataset.csv")

#cooking survey
primary_secondary_cooking <- read_csv("Primary and secondary cooking practices dataset.csv")
```

## Recalculating Linnea and Flavio's weights in R
```{r}
LW_EA_weights <- GL_EA_weights %>%
  select(!prob_1:weight_2010) %>% #remove weighting variables 
  mutate(ea_select_prob = eas_selected/eas_2010, #Prob select the cluster (EA)
         hh_select_within_ea_prob = 20/ea_hhs_2010) %>% #Prob select HH within each EA
  mutate(hh_select_prob = ea_select_prob * hh_select_within_ea_prob) %>% #prob select HH 
  mutate(weight = 1/hh_select_prob) #obtain weight
```

## Joining the demographic and cooking data 
```{r}
#join the weights to the demographic data
survey_with_weights <- left_join(demographics, LW_EA_weights, by = c("eacode", "region")) %>%
  filter(!is.na(weight))

#add the cooking data
full_survey <- left_join(survey_with_weights, primary_secondary_cooking, by = "hh_id") %>%
  
  #add LPG main cookstove column
  mutate(LPG_main = ifelse(primary_cookstove == "Gas:(LPG)/cooking gas stove", "Yes", "No")) %>%
  
  #add charcoal/wood main cookstove column
  mutate(CW_main = ifelse(primary_cookstove == "3-stone stove/open fire" | primary_cookstove == "Charcoal stove", "Yes", "No")) %>%
  
  #change NA values in charcoal/lpg main to "No". These respondents skipped over this question bc they don't cook
  mutate(LPG_main = coalesce(LPG_main, "No"),
         CW_main = coalesce(CW_main, "No"))
```

## Collapsing region and primary cooking type 
```{r}
#collapse some of the regions and fuel types so there are enough in each group ----
full_survey_collapsed <- full_survey %>%
  
  #collapse region
  mutate(collapsed_region = case_when(
  region == "Western" | region == "Western North" ~ "west_west_north",
  region %in% c("Upper East", "Upper West", "North East", 
                "Northern", "Savannah", "Oti") ~ "northern_regions",
  region %in% c("Bono", "Bono East", "Ahafo") ~ "mid_west_regions",
  TRUE ~ region)) %>%
  
  #collapse fuel type
  mutate(collapsed_fuel = case_when(
    primary_cookstove == "Gas:(LPG)/cooking gas stove" ~ "LPG",
    primary_cookstove == "Charcoal stove" ~ "charcoal",
    primary_cookstove == "3-stone stove/open fire" ~ "wood",
    is.na(primary_cookstove) ~ "none_other",
    TRUE ~ "none_other"
  ))
```


## Setting up the initial survey design 
```{r}
# Survey design using survey package
survey_design <- svydesign(id=~eacode, #specify clusters 
                           fpc= ~fpc, #include finite population correction (GL and FM calculations)
                           weights= ~weight, #specify the survey weights
                           strata= ~region, #specify the region strata
                           data=full_survey_collapsed)
```


# POPULATION VALUES

## National population totals 

```{r}
### urban/rural total

pop.urban_rural_str <- data.frame(urban_rural_str=c("urban", "rural"), Freq=c(5090702, 3254711))
```


```{r}
### LPG main total

pop.LPG_main <- data.frame(LPG_main = c("Yes", "No"), Freq = c(3079458, 5265956))
```


```{r}
### charcoal/wood main total 

pop.CW_main <- data.frame(CW_main = c("Yes", "No"), Freq = c(4531560, 3813854))
```


```{r}
### primary fuel categories 

pop.primary_fuel <- data.frame(collapsed_fuel = c("none_other", "wood", "LPG", "charcoal"), Freq = c(732934, 2594937, 3086324, 1942771))
```

## Regional population totals 

```{r}
### regional 2021 HH populations 

pop.region_hh <- data.frame(
  region = c("Western", "Central", "Greater Accra", "Volta", "Eastern", "Ashanti", "Western North", "Ahafo", "Bono", "Bono East", "Oti", "Northern", "Savannah", "North East", "Upper East", "Upper West"), 
  Freq = c(621349, 838493, 1702160, 491373, 881328, 1523101, 240086, 152801, 317994, 288725, 174031, 437934, 133114, 108088, 264404, 190193))
```


### regional LPG_main fuel 

```{r}
# calculating LPG as main fuel for each region

#regional HH populations
hh_pop = c(621349, 838493, 1702160, 491373, 881328, 1523101, 240086, 152801, 317994, 288725, 174031, 437934, 133114, 108088, 264404, 190193)

#percent using LPG as main source of cooking fuel
LPG_percent = c(0.377, 0.371, 0.682, 0.337, 0.335, 0.381, 0.178, 0.205, 0.279, 0.167, 0.102, 0.104, 0.043, 0.042, 0.138, 0.120)

#HH main fuel LPG for each region
LPG_main_region = round(hh_pop * LPG_percent, 0)

#reformat
pop.region_LPG <- data.frame(
  region = c("Western", "Central", "Greater Accra", "Volta", "Eastern", "Ashanti", "Western North", "Ahafo", "Bono", "Bono East", "Oti", "Northern", "Savannah", "North East", "Upper East", "Upper West"), 
  Freq = hh_pop,
  LPG_percent = LPG_percent
) %>%
  mutate(LPG_yes = round(Freq*LPG_percent, 0),
         LPG_no = round(Freq*(1-LPG_percent), 0)) %>%
  select(region, LPG_yes, LPG_no) 


# get population LPG usage for each region of the collapsed regions ----
west_west_north <- pop.region_LPG %>%
  filter(region %in% c("Western", "Western North")) %>%
  summarise(
    region = "west_west_north",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )

north_regions <- pop.region_LPG %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti")) %>%
  summarise(
    region = "northern_regions",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )

midwest_regions <- pop.region_LPG %>%
  filter(region %in% c("Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "mid_west_regions",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )

#get dataset with all of the large regions that didn't need to be combined ----
large_regions <- pop.region_LPG %>%
  filter(region %in% c("Eastern", "Central", "Greater Accra", "Ashanti", "Volta"))

collapsed_region_LPG <- bind_rows(west_west_north, north_regions, midwest_regions, large_regions)


#Combine LPG yes/no columns with each row specifying which is applicable 
pop_LPG_region_long <- collapsed_region_LPG %>%
  pivot_longer(cols = c(LPG_yes, LPG_no), names_to = "LPG_main", values_to = "Count")

# Replace "LPG_yes" with "Yes" and "LPG_no" with "No"
pop_LPG_region_long$LPG_main <- ifelse(pop_LPG_region_long$LPG_main == "LPG_yes", "Yes", "No")

# reformat this data so each row is a household (necessary for creating pop.table below)
pop_LPG_region_long <- pop_LPG_region_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of LPG main stove by collapsed regions
pop.table_LPG <- xtabs(~collapsed_region+LPG_main, pop_LPG_region_long)
```

### regional charcoal/wood main fuel 
```{r}
# calculating charcoal/wood (CW) as main fuel for each region

#regional HH population
hh_pop = c(621349, 838493, 1702160, 491373, 881328, 1523101, 240086, 152801, 317994, 288725, 174031, 437934, 133114, 108088, 264404, 190193)

#percent using charcoal or wood as main cooking fuel source
CW_percent = c(0.506, 0.547, 0.227, 0.621, 0.586, 0.508, 0.742, 0.707, 0.620, 0.750, 0.848, 0.829, 0.881, 0.931, 0.759, 0.828)

#number HH using CW for main cooking fuel
CW_main_region = round(hh_pop * CW_percent, 0)

pop.region_CW <- data.frame(
  region = c("Western", "Central", "Greater Accra", "Volta", "Eastern", "Ashanti", "Western North", "Ahafo", "Bono", "Bono East", "Oti", "Northern", "Savannah", "North East", "Upper East", "Upper West"), 
  Freq = hh_pop,
  CW_percent = CW_percent
) %>%
  mutate(CW_yes = round(Freq*CW_percent, 0),
         CW_no = round(Freq*(1-CW_percent), 0)) %>%
  select(region, CW_yes, CW_no) 


# get population LPG usage for each region of the collapsed regions ----
west_west_north <- pop.region_CW %>%
  filter(region %in% c("Western", "Western North")) %>%
  summarise(
    region = "west_west_north",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )

north_regions <- pop.region_CW %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti")) %>%
  summarise(
    region = "northern_regions",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )

midwest_regions <- pop.region_CW %>%
  filter(region %in% c("Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "mid_west_regions",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )

#get dataset with all of the large regions that didn't need to be combined ----
large_regions <- pop.region_CW %>%
  filter(region %in% c("Eastern", "Central", "Greater Accra", "Ashanti", "Volta"))

collapsed_region_CW <- bind_rows(west_west_north, north_regions, midwest_regions, large_regions)


#Combine CW yes/no columns with each row specifying which is applicable 
pop_CW_region_long <- collapsed_region_CW %>%
  pivot_longer(cols = c(CW_yes, CW_no), names_to = "CW_main", values_to = "Count")

# Replace "CW_yes" with "Yes" and "CW_no" with "No"
pop_CW_region_long$CW_main <- ifelse(pop_CW_region_long$CW_main == "CW_yes", "Yes", "No")

# reformat this data so each row is a household (necessary for creating table below)
pop_CW_region_long <- pop_CW_region_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of CW main stove by collapsed regions
pop.table_CW <- xtabs(~collapsed_region+CW_main, pop_CW_region_long)
```

### regional main fuel
```{r}
none = c(68717,64761,140709,19124,64243,158757,18141,12857,30469,22818,8238,24587,9615,2480,7088,9240)
  
wood = c(186438,218835,36216,163840,282771,356872,143400,79069,141686,138749,109925,278929,91769,89764,159442,117232)
  
LPG = c(234023,311238,1157759,165592,295140,579078,42713,31282,88699,48228,17780,45379,5768,4579,36339,22727)

charcoal = c(127558,239318,349266,141057,233782,416047,34646,28904,55242,77728,37579,84153,25421,10854,41005,40211)

other <- c(620787,837879,1698374,491091,880838,1521844,239948,152690,317864,288506,173924,437788,133045,108053,264246,190089) - none - wood - LPG - charcoal


pop.region_main_fuel <- data.frame(
  region = c("Western", "Central", "Greater Accra", "Volta", "Eastern", "Ashanti", "Western North", "Ahafo", "Bono", "Bono East", "Oti", "Northern", "Savannah", "North East", "Upper East", "Upper West"), 
  
  none_other = none + other,
  wood = wood,
  LPG = LPG,
  charcoal = charcoal)



# get population LPG usage for each region of the collapsed regions ----
west_west_north <- pop.region_main_fuel %>%
  filter(region %in% c("Western", "Western North")) %>%
  summarise(
    region = "west_west_north",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )

north_regions <- pop.region_main_fuel %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti")) %>%
  summarise(
    region = "northern_regions",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )

midwest_regions <- pop.region_main_fuel %>%
  filter(region %in% c("Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "mid_west_regions",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )

#get dataset with all of the large regions that didn't need to be combined ----
large_regions <- pop.region_main_fuel %>%
  filter(region %in% c("Eastern", "Central", "Greater Accra", "Ashanti", "Volta"))

collapsed_region_primary_fuel <- bind_rows(west_west_north, north_regions, midwest_regions, large_regions)



#Combine LPG yes/no columns with each row specifying which is applicable 
pop_region_primary_fuel_long <- collapsed_region_primary_fuel %>%
  pivot_longer(cols = c(none_other, wood, LPG, charcoal), names_to = "collapsed_fuel", values_to = "Count") #names need to match what is in the survey!!

# reformat this data so each row is a household (necessary for creating pop.table below)
pop_region_primary_fuel_long <- pop_region_primary_fuel_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of LPG main stove by collapsed regions
pop.table_primary_fuel <- xtabs(~collapsed_region+collapsed_fuel, pop_region_primary_fuel_long)
```

### regional urbab/rural 
```{r}
#regional 2021 HH populations 
pop.region_urban_rural_hh <- data.frame(
  region = c("Western", "Central", "Greater Accra", "Volta", "Eastern", "Ashanti", "Western North", "Ahafo", "Bono", "Bono East", "Oti", "Northern", "Savannah", "North East", "Upper East", "Upper West"), 
  rural = c(292842, 344366, 123225, 277898, 413370, 566043,
  162918, 73304, 120206, 123162, 112719, 201727, 89556, 69922, 189290, 129218),
  urban = c(328507, 494127, 1578935, 213475, 467958, 957058,
  77168, 79497, 197788, 165563, 61312, 236207, 43558, 38166, 75114, 60975))


# get population LPG usage for each region of the collapsed regions ----
west_west_north <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Western", "Western North")) %>%
  summarise(
    region = "west_west_north",
    urban = sum(urban),
    rural = sum(rural)
  )

north_regions <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti")) %>%
  summarise(
    region = "northern_regions",
    urban = sum(urban),
    rural = sum(rural)
  )

midwest_regions <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "mid_west_regions",
    urban = sum(urban),
    rural = sum(rural)
  )

#get dataset with all of the large regions that didn't need to be combined ----
large_regions <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Eastern", "Central", "Greater Accra", "Ashanti", "Volta"))

collapsed_region_urban_rural_hh <- bind_rows(west_west_north, north_regions, midwest_regions, large_regions)


#Combine LPG yes/no columns with each row specifying which is applicable 
pop_region_urban_rural_long <- collapsed_region_urban_rural_hh %>%
  pivot_longer(cols = c(rural, urban), names_to = "urban_rural_str", values_to = "Count") #names need to match what is in the survey!!

# reformat this data so each row is a household (necessary for creating pop.table below)
pop_region_urban_rural_long <- pop_region_urban_rural_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of LPG main stove by collapsed regions
pop.table_urban_rural <- xtabs(~collapsed_region+urban_rural_str, pop_region_urban_rural_long)
```


# Setting up the initial survey design
```{r}
#specify the initial survey design again
survey_design <- svydesign(id=~eacode, #specify clusters 
                           fpc= ~fpc, #include finite population correction (GL and FM calculations)
                           weights= ~weight, #specify the survey weights
                           strata= ~region, #specify the region strata
                           data=full_survey_collapsed)

# Create a replicate-weights survey design object from a traditional strata/cluster survey design object (necessary for raking I believe)
replicate_survey_design <- as.svrepdesign(survey_design)
```

# RAKE 1
```{r}
raked_surv <- rake(replicate_survey_design, list(~urban_rural_str, ~LPG_main, ~CW_main), list(pop.urban_rural_str, pop.LPG_main, pop.CW_main))


data.svy.rake.trim <- trimWeights(raked_surv, lower=0.3, upper=3,
                                  strict=TRUE)


svymean(~total_hh_num, raked_surv, na.rm = TRUE)
#svymean(~total_hh_num, data.svy.rake.trim, na.rm = TRUE)



calibrated_surv <- calibrate(design = replicate_survey_design, 
                             formula = list(~urban_rural_str, ~LPG_main, ~CW_main),
                             population = list(pop.urban_rural_str, pop.LPG_main, pop.CW_main),
                             bounds = c(-10, 10),
                             trim = TRUE,
                             force = TRUE,
                             maxit = 20,
                             epsilon = 0.9)

anes_rake_surv <- anesrake(inputter = pop.urban_rural_str,
                           dataframe = full_survey_collapsed,
                           caseid = full_survey_collapsed$hh_id,
                           weightvec = full_survey_collapsed$weight,
                           cap = 5,
                           verbose = TRUE,
                           maxit = 1000,
                           type = "nolim"
                           )







max(raked_surv$pweights)

mean(raked_surv$pweights) * 5 # recommended max weight for trimming

test <- trimWeights(raked_surv, lower = 0.1, upper = 5, strict = TRUE)

weights(test)

stack(table())
```

# RAKE 2

```{r}
raked_surv <- rake(replicate_survey_design, list(~urban_rural_str, ~LPG_main, ~CW_main, ~region), list(pop.urban_rural_str, pop.LPG_main, pop.CW_main, pop.region_hh))
```

# RAKE 3

```{r}
raked_surv <- rake(replicate_survey_design, list(~LPG_main+collapsed_region, ~urban_rural_str), list(pop.table_LPG, pop.urban_rural_str))
```

# RAKE 4

```{r}
raked_surv <- rake(replicate_survey_design, 
                   list(~urban_rural_str+collapsed_region, ~collapsed_region+collapsed_fuel), 
                   list(pop.table_urban_rural, pop.table_primary_fuel))
```

# RAKE 5

```{r}
raked_surv <- rake(replicate_survey_design, 
                   list(~urban_rural_str+collapsed_region), 
                   list(pop.table_urban_rural))
```


# RAKE 6
```{r}
raked_surv <- rake(replicate_survey_design, 
                   list(~urban_rural_str+collapsed_region, ~collapsed_fuel), 
                   list(pop.table_urban_rural, pop.primary_fuel))
```


# RAKE 7
```{r}
raked_surv <- rake(replicate_survey_design, 
                   list(~urban_rural_str, ~collapsed_fuel), 
                   list(pop., pop.primary_fuel))
```