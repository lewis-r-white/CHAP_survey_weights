---
title: "Raking: Organized by GSS population"
author: "Lewis White and Linnea Graham"
date: "2023-12-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libraries
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(survey)
library(readxl)
```

## Set Paths
```{r, message=FALSE, warning=FALSE}
if (Sys.getenv('USER') == "lewiswhite") {
    
  # set working directory
  setwd("/Users/lewiswhite/CHAP_columbia/CHAP_survey_weights")
  
  #includes the weights from Linnea and Flavio's V4 weights 
  GL_EA_weights <- read_csv("weight_2010_full_results.csv")
  
  #responses to the survey
  demographics <- read_csv("Demographics dataset.csv")
  
  #cooking survey
  primary_secondary_cooking <- read_csv("Primary and secondary cooking practices dataset.csv")
  
  #house structure
  house_structure <- read_csv("House structure (non randomized).csv")
  
  #GSS-2021
  gss <- read_excel("gss_2021.xlsx")
     
}

if (Sys.getenv('USER') == "linneagraham") {

  ROOT <- ("/Volumes/GoogleDrive-100807402805951836278/.shortcut-targets-by-id/1B0iSt7ZGnvhcH8p5MtZccbjg10Pho9qT/ColumbiaWorldProjectsGhana/03_Phase_1/01_Assessment_Household_Needs")

  GL_EA_weights <- read_csv(file.path(ROOT, "Survey Weights/output/weight_2010_full_results.csv"))

  demographics <- read_csv(file.path(ROOT, "Public Use Dataset/Modules/Demographics dataset.csv"))
  primary_secondary_cooking <- read_csv(file.path(ROOT,"Public Use Dataset/Modules/Primary and secondary cooking practices dataset.csv"))
  house_structure <- read_csv(file.path(ROOT, "Public Use Dataset/Modules/House structure (non randomized).csv"))

  gss <- read_excel(file.path(ROOT, "Survey Weights/input/gss_2021.xlsx"))
}

```

## Recalculating Linnea and Flavio's weights in R
```{r, message=FALSE, warning=FALSE}
LW_EA_weights <- GL_EA_weights %>%
  select(!prob_1:weight_2010) %>% #remove weighting variables 
  mutate(ea_select_prob = eas_selected/eas_2010, #Prob select the cluster (EA)
         hh_select_within_ea_prob = 20/ea_hhs_2010) %>% #Prob select HH within each EA
  mutate(hh_select_prob = ea_select_prob * hh_select_within_ea_prob) %>% #prob select HH 
  mutate(weight = 1/hh_select_prob) #obtain weight
```

## Joining the demographic and cooking data 
```{r, message=FALSE, warning=FALSE}
#join the weights to the demographic data
survey_with_weights <- left_join(demographics, LW_EA_weights, by = c("eacode", "region")) %>%
  filter(!is.na(weight))

#add the cooking data
full_survey <- left_join(survey_with_weights, primary_secondary_cooking, by = "hh_id") %>%
  
  #add LPG main cookstove column
  mutate(LPG_main = ifelse(primary_cookstove == "Gas:(LPG)/cooking gas stove", "Yes", "No")) %>%
  
  #add charcoal/wood main cookstove column
  mutate(CW_main = ifelse(primary_cookstove == "3-stone stove/open fire" | primary_cookstove == "Charcoal stove", "Yes", "No")) %>%
  
  #change NA values in charcoal/lpg main to "No". These respondents skipped over this question bc they don't cook
  mutate(LPG_main = coalesce(LPG_main, "No"),
         CW_main = coalesce(CW_main, "No")) %>%
  
  #add in house structure data
  left_join(house_structure)


```

## Adding collapsed region and collapsd primary cooking type 
```{r, message=FALSE, warning=FALSE}
#collapse some of the regions and fuel types so there are enough in each group ----
full_survey_collapsed <- full_survey %>%
  
  #collapse region
  mutate(collapsed_region = case_when(
  region %in% c("Ashanti", "Eastern") ~ "middle",
  region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti", "Bono", "Bono East", "Ahafo") ~ "northern",
  region %in% c("Greater Accra", "Volta") ~ "southeast",
  region %in% c("Central", "Western", "Western North") ~ "southwest",
  TRUE ~ region)) %>%
  
  #collapse fuel type
  mutate(collapsed_fuel = case_when(
    primary_cookstove == "Gas:(LPG)/cooking gas stove" ~ "LPG",
    primary_cookstove == "Charcoal stove" ~ "charcoal",
    primary_cookstove == "3-stone stove/open fire" ~ "wood",
    is.na(primary_cookstove) ~ "none_other",
    TRUE ~ "none_other"
  ))
```


## Setting up the initial survey design 
```{r, message=FALSE, warning=FALSE}
# Survey design using survey package
survey_design <- svydesign(id=~eacode, #specify clusters 
                           weights= ~weight, #specify the survey weights
                           strata= ~region, #specify the region strata
                           data=full_survey_collapsed)

#fpc not included as sampling less than 5% population of EAs
```


# POPULATION VALUES

## National population totals 

```{r, message=FALSE, warning=FALSE}
### urban/rural total
pop.urban_rural_str <-
  data.frame(
    urban_rural_str = c("urban", "rural"),
    Freq = c(
      subset(gss, region == "Total")$hh_pop_urban,
      subset(gss, region == "Total")$hh_pop_rural
    )
  )
```


```{r, message=FALSE, warning=FALSE}
### LPG main total
hh_pop_tot <- subset(gss, region == "Total")$hh_pop

frac_lpg <- subset(gss, region == "Total")$fuel_lpg / subset(gss, region == "Total")$hh_pop_fuel

pop.LPG_main <-
  data.frame(
    LPG_main = c("Yes", "No"),
    Freq = c(frac_lpg * hh_pop_tot,
             (1 - frac_lpg) * hh_pop_tot)
  )
```


```{r, message=FALSE, warning=FALSE}
### charcoal/wood main total 

frac_CW <- (subset(gss, region == "Total")$fuel_wood + 
              subset(gss, region == "Total")$fuel_char) / subset(gss, region == "Total")$hh_pop_fuel

pop.CW_main <-
  data.frame(
    CW_main = c("Yes", "No"),
    Freq = c(frac_CW * hh_pop_tot,
             (1 - frac_CW) * hh_pop_tot)
  )
```


```{r, message=FALSE, warning=FALSE}
### primary fuel categories 

frac_char <- subset(gss, region == "Total")$fuel_char / subset(gss, region == "Total")$hh_pop_fuel
frac_wood <- subset(gss, region == "Total")$fuel_wood / subset(gss, region == "Total")$hh_pop_fuel
  
pop.primary_fuel <-
  data.frame(
    collapsed_fuel = c("none_other", "wood", "LPG", "charcoal"),
    Freq = c(
      round((1 - (frac_lpg + frac_wood + frac_char)) * hh_pop_tot, 0),
      round(frac_wood * hh_pop_tot, 0),
      round(frac_lpg * hh_pop_tot, 0),
      round(frac_char * hh_pop_tot, 0)
    )
  )

```

## Regional population totals 

```{r, message=FALSE, warning=FALSE}
### regional 2021 HH populations 

gss_regional <- filter(gss, region != "Total") 

pop.region_hh <- data.frame(
  region = gss_regional$region,
  Freq = gss_regional$hh_pop
)
```


### regional LPG_main fuel 

```{r, message=FALSE, warning=FALSE}
# calculating LPG as main fuel for each region

pop.region_LPG <- gss_regional %>% 
  mutate(lpg_frac = fuel_lpg / hh_pop_fuel,
         LPG_yes = round(lpg_frac*hh_pop, 0),
         LPG_no = round((1-lpg_frac)*hh_pop), 0) %>%
  select(region, LPG_yes, LPG_no)


northern <- pop.region_LPG %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti", "Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "northern",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )


middle <- pop.region_LPG %>%
  filter(region %in% c("Ashanti", "Eastern")) %>%
  summarise(
    region = "middle",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )

southeast <- pop.region_LPG %>%
  filter(region %in% c("Greater Accra", "Volta")) %>%
  summarise(
    region = "southeast",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )

southwest <- pop.region_LPG %>%
  filter(region %in% c("Central", "Western", "Western North")) %>%
  summarise(
    region = "southwest",
    LPG_yes = sum(LPG_yes),
    LPG_no = sum(LPG_no)
  )


collapsed_region_LPG <- bind_rows(northern, middle, southeast, southwest)

#Combine LPG yes/no columns with each row specifying which is applicable 
pop_LPG_region_long <- collapsed_region_LPG %>%
  pivot_longer(cols = c(LPG_yes, LPG_no), names_to = "LPG_main", values_to = "Count")

# Replace "LPG_yes" with "Yes" and "LPG_no" with "No"
pop_LPG_region_long$LPG_main <- ifelse(pop_LPG_region_long$LPG_main == "LPG_yes", "Yes", "No")

# reformat this data so each row is a household (necessary for creating pop.table below)
pop_LPG_region_long <- pop_LPG_region_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of LPG main stove by collapsed regions
pop.table_LPG <- xtabs(~collapsed_region+LPG_main, pop_LPG_region_long)
```

### regional charcoal/wood main fuel 
```{r, message=FALSE, warning=FALSE}
# calculating charcoal/wood (CW) as main fuel for each region

pop.region_CW <- gss_regional %>% 
  mutate(CW_frac = (fuel_char + fuel_wood) / hh_pop_fuel,
         CW_yes = round(CW_frac*hh_pop, 0),
         CW_no = round((1-CW_frac)*hh_pop), 0) %>%
  select(region, CW_yes, CW_no)



northern <- pop.region_CW %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti", "Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "northern",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )


middle <- pop.region_CW %>%
  filter(region %in% c("Ashanti", "Eastern")) %>%
  summarise(
    region = "middle",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )

southeast <- pop.region_CW %>%
  filter(region %in% c("Greater Accra", "Volta")) %>%
  summarise(
    region = "southeast",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )

southwest <- pop.region_CW %>%
  filter(region %in% c("Central", "Western", "Western North")) %>%
  summarise(
    region = "southwest",
    CW_yes = sum(CW_yes),
    CW_no = sum(CW_no)
  )

collapsed_region_CW <- bind_rows(northern, middle, southeast, southwest)


#Combine CW yes/no columns with each row specifying which is applicable 
pop_CW_region_long <- collapsed_region_CW %>%
  pivot_longer(cols = c(CW_yes, CW_no), names_to = "CW_main", values_to = "Count")

# Replace "CW_yes" with "Yes" and "CW_no" with "No"
pop_CW_region_long$CW_main <- ifelse(pop_CW_region_long$CW_main == "CW_yes", "Yes", "No")

# reformat this data so each row is a household (necessary for creating table below)
pop_CW_region_long <- pop_CW_region_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of CW main stove by collapsed regions
pop.table_CW <- xtabs(~collapsed_region+CW_main, pop_CW_region_long)
```

### regional main fuel
```{r, message=FALSE, warning=FALSE}
#specify known main fuel population values for each of the regions 
pop.region_main_fuel <- gss_regional %>% 
  mutate(none_other = fuel_none + fuel_other) %>%
  rename(LPG = fuel_lpg, 
         wood = fuel_wood, 
         charcoal = fuel_char) %>%
  select(region, none_other, wood, LPG, charcoal) %>%
  
  #apply scaling factor so population matches GSS total value
  mutate(none_other = round(none_other * subset(gss, region == "Total")$hh_pop/subset(gss, region == "Total")$hh_pop_fuel, 0),
         LPG = round(LPG * subset(gss, region == "Total")$hh_pop/subset(gss, region == "Total")$hh_pop_fuel,0),
         wood = round(wood * subset(gss, region == "Total")$hh_pop/subset(gss, region == "Total")$hh_pop_fuel, 0),
         charcoal = round(charcoal * subset(gss, region == "Total")$hh_pop/subset(gss, region == "Total")$hh_pop_fuel, 0))

northern <- pop.region_main_fuel %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti", "Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "northern",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )


middle <- pop.region_main_fuel %>%
  filter(region %in% c("Ashanti", "Eastern")) %>%
  summarise(
    region = "middle",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )

southeast <- pop.region_main_fuel %>%
  filter(region %in% c("Greater Accra", "Volta")) %>%
  summarise(
    region = "southeast",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )

southwest <- pop.region_main_fuel %>%
  filter(region %in% c("Central", "Western", "Western North")) %>%
  summarise(
    region = "southwest",
    none_other = sum(none_other),
    wood = sum(wood),
    LPG = sum(LPG),
    charcoal = sum(charcoal)
  )

collapsed_region_primary_fuel <- bind_rows(northern, middle, southeast, southwest)


#Combine primary fuel with each row specifying which is applicable 
pop_region_primary_fuel_long <- collapsed_region_primary_fuel %>%
  pivot_longer(cols = c(none_other, wood, LPG, charcoal), names_to = "collapsed_fuel", values_to = "Count") #names need to match what is in the survey!!

# reformat this data so each row is a household (necessary for creating pop.table below)
pop_region_primary_fuel_long <- pop_region_primary_fuel_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of LPG main stove by collapsed regions
pop.table_primary_fuel <- xtabs(~collapsed_region+collapsed_fuel, pop_region_primary_fuel_long)
```

### regional urban/rural 
```{r, message=FALSE, warning=FALSE}
#regional 2021 HH populations 
pop.region_urban_rural_hh <- gss_regional %>%
  select(region, hh_pop_rural, hh_pop_urban) %>%
  rename(rural = hh_pop_rural, 
         urban = hh_pop_urban)


northern <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Upper East", "Upper West", "North East", "Northern", "Savannah", "Oti", "Bono", "Bono East", "Ahafo")) %>%
  summarise(
    region = "northern",
    urban = sum(urban),
    rural = sum(rural)
  )


middle <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Ashanti", "Eastern")) %>%
  summarise(
    region = "middle",
    urban = sum(urban),
    rural = sum(rural)
  )

southeast <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Greater Accra", "Volta")) %>%
  summarise(
    region = "southeast",
    urban = sum(urban),
    rural = sum(rural)
  )

southwest <- pop.region_urban_rural_hh %>%
  filter(region %in% c("Central", "Western", "Western North")) %>%
  summarise(
    region = "southwest",
    urban = sum(urban),
    rural = sum(rural)
  )

collapsed_region_urban_rural_hh <- bind_rows(northern, middle, southeast, southwest)


#Combine LPG yes/no columns with each row specifying which is applicable 
pop_region_urban_rural_long <- collapsed_region_urban_rural_hh %>%
  pivot_longer(cols = c(rural, urban), names_to = "urban_rural_str", values_to = "Count") #names need to match what is in the survey!!

# reformat this data so each row is a household (necessary for creating pop.table below)
pop_region_urban_rural_long <- pop_region_urban_rural_long %>%
  uncount(Count) %>%
  rename(collapsed_region = region)

#create table of LPG main stove by collapsed regions
pop.table_urban_rural <- xtabs(~collapsed_region+urban_rural_str, pop_region_urban_rural_long)
```


# Setting up the initial survey design
```{r, message=FALSE, warning=FALSE}
#specify the initial survey design again
survey_design <- svydesign(id=~eacode, #specify clusters
                           weights= ~weight, #specify the survey weights
                           strata= ~region, #specify the region strata
                           data=full_survey_collapsed)
```


## Before raking, explore LG + FM base weights

### loop to find main fuel counts for LG + FM weight no raking
```{r, message=FALSE, warning=FALSE}
#obtain a list of the regions
regions <- gss_regional$region

#loop through each of the regions in the list 
for (i in seq_along(regions)){
  
  #subset the survey to the region
  region_subset = subset(survey_design, region == regions[i])
  
  #create list of regions populations
  regions_pop <- pop.region_hh[[2]]
  
  #obtain population for specific region in the loop
  region_pop = regions_pop[i]
  
  #get the fuel information for the region
  region_fuel  <- as.data.frame(svytotal(~collapsed_fuel, 
                                         design = region_subset, 
                                         na.rm = TRUE))
  
  #obtain just the LPG total for the region 
  region_lpg <- region_fuel[2,1]
  
  #calculate the percent LPG for the region
  region_pct_lpg <- round((region_lpg/region_pop)*100,1)
  
  #print the result for each
  print(region_pct_lpg)
}
```


# RAKE 1
```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, list(~urban_rural_str, ~LPG_main, ~CW_main), list(pop.urban_rural_str, pop.LPG_main, pop.CW_main), control = list(maxit = 38, epsilon = 1))

summary(weights(raked_surv, type = "sampling"))
```

## trimming thr weights
```{r, message=FALSE, warning=FALSE}
upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

#Set up weight trimming
trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)

#CHECK OUT RESULTS 

#original raked survey
summary(weights(raked_surv, type = "sampling"))

#trimmed survey weights
summary(weights(trimmed_raked_surv, type = "sampling"))

#original raked survey
svymean(~total_hh_num, raked_surv, na.rm = TRUE)

#trimmed survey
svymean(~total_hh_num, trimmed_raked_surv, na.rm = TRUE)  
```



## National Population Results from Rake 1

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)
```

## Examine new weights from Rake 1

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 1",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_1 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 1)

# Write the tibble to a CSV file
write_csv(survey_all_weights_1, "rake_1_weights.csv")
```




# RAKE 2

```{r, message=FALSE, warning=FALSE}
#raked_surv <- rake(replicate_survey_design, list(~urban_rural_str, ~LPG_main, ~CW_main, ~region), list(pop.urban_rural_str, pop.LPG_main, pop.CW_main, pop.region_hh))

raked_surv <- rake(survey_design, list(~urban_rural_str, ~LPG_main, ~CW_main, ~region), list(pop.urban_rural_str, pop.LPG_main, pop.CW_main, pop.region_hh), control = list(maxit = 40, epsilon = 1))

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 2

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)
```

## Examine new weights from Rake 2

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 2",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_2 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 2)

# Write the tibble to a CSV file
write_csv(survey_all_weights_2, "rake_2_weights.csv")
```


# RAKE 3

```{r, message=FALSE, warning=FALSE}

raked_surv <- rake(survey_design, list(~LPG_main+collapsed_region, ~urban_rural_str), list(pop.table_LPG, pop.urban_rural_str))

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)

```

## National Population Results from Rake 3

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)
```

## Examine new weights from Rake 3

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 3",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_3 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 3)

# Write the tibble to a CSV file
write_csv(survey_all_weights_3, "rake_3_weights.csv")
```



# RAKE 4

```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, 
                   list(~urban_rural_str+collapsed_region, ~collapsed_region+collapsed_fuel), 
                   list(pop.table_urban_rural, pop.table_primary_fuel), control = list(maxit = 15, epsilon = 1))

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 4

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)


#check out hh structures
svytotal(~hh_water_source, design = trimmed_raked_surv, na.rm = TRUE)

svymean(~house_rooms, design = trimmed_raked_surv, na.rm = TRUE)

```

## loop to find main fuel counts 

```{r, message=FALSE, warning=FALSE}
#obtain a list of the regions
regions <- gss_regional$region

#loop through each of the regions in the list 
for (i in seq_along(regions)){
  
  #subset the raked survey to the region
  region_subset = subset(trimmed_raked_surv, region == regions[i])
  
  #create list of regions populations
  regions_pop <- pop.region_hh[[2]]
  
  #obtain population for specific region in the loop
  region_pop = regions_pop[i]
  
  #get the fuel information for the region
  region_fuel  <- as.data.frame(svytotal(~collapsed_fuel, 
                                         design = region_subset, 
                                         na.rm = TRUE))
  
  #obtain just the LPG total for the region 
  region_lpg <- region_fuel[2,1]
  
  #calculate the percent LPG for the region
  region_pct_lpg <- round((region_lpg/region_pop)*100,1)
  
  #print the result for each
  print(region_pct_lpg)
}
```


## Examine new weights from Rake 4

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 4",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_4 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 4)

# Write the tibble to a CSV file
write_csv(survey_all_weights_4, "rake_4_weights.csv")
```

# RAKE 5 see anesrake doc

# RAKE 5b

```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, list(~urban_rural_str, ~collapsed_fuel, ~region), list(pop.urban_rural_str, pop.primary_fuel, pop.region_hh), control = list(maxit = 20, epsilon = 1, verbose = FALSE))

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 5b

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE, deff = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE, deff = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv, deff = TRUE)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)


#check out hh structures
svytotal(~hh_water_source, design = trimmed_raked_surv, na.rm = TRUE)
svytotal(~hh_water_source, design = survey_design, na.rm = TRUE)

svymean(~house_rooms, design = trimmed_raked_surv, na.rm = TRUE)
svymean(~house_rooms, design = survey_design, na.rm = TRUE)
```

## loop to find main fuel counts 

```{r, message=FALSE, warning=FALSE}
#obtain a list of the regions
regions <- gss_regional$region

#loop through each of the regions in the list 
for (i in seq_along(regions)){
  
  #subset the raked survey to the region
  region_subset = subset(trimmed_raked_surv, region == regions[i])
  
  #create list of regions populations
  regions_pop <- pop.region_hh[[2]]
  
  #obtain population for specific region in the loop
  region_pop = regions_pop[i]
  
  #get the fuel information for the region
  region_fuel  <- as.data.frame(svytotal(~collapsed_fuel, 
                                         design = region_subset, 
                                         na.rm = TRUE))
  
  #obtain just the LPG total for the region 
  region_lpg <- region_fuel[2,1]
  
  #calculate the percent LPG for the region
  region_pct_lpg <- round((region_lpg/region_pop)*100,1)
  
  #print the result for each
  print(region_pct_lpg)
}
```


## Examine new weights from Rake 5b

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 5b",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_5b <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 5)

# Write the tibble to a CSV file
write_csv(survey_all_weights_5b, "rake_5b_weights.csv")
```


# RAKE 6 IN THE anesrake_version.Rmd doc. 


# RAKE 7

```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, 
                   list(~urban_rural_str, ~region), 
                   list(pop.urban_rural_str, pop.region_hh)
                   )

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 7

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE, deff = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv, deff = TRUE)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)


#check out hh structures
svytotal(~hh_water_source, design = trimmed_raked_surv, na.rm = TRUE)

svymean(~house_rooms, design = trimmed_raked_surv, na.rm = TRUE)
```

## loop to find main fuel counts 

```{r, message=FALSE, warning=FALSE}
#obtain a list of the regions
regions <- gss_regional$region

#loop through each of the regions in the list 
for (i in seq_along(regions)){
  
  #subset the raked survey to the region
  region_subset = subset(trimmed_raked_surv, region == regions[i])
  
  #create list of regions populations
  regions_pop <- pop.region_hh[[2]]
  
  #obtain population for specific region in the loop
  region_pop = regions_pop[i]
  
  #get the fuel information for the region
  region_fuel  <- as.data.frame(svytotal(~collapsed_fuel, 
                                         design = region_subset, 
                                         na.rm = TRUE))
  
  #obtain just the LPG total for the region 
  region_lpg <- region_fuel[2,1]
  
  #calculate the percent LPG for the region
  region_pct_lpg <- round((region_lpg/region_pop)*100,1)
  
  #print the result for each
  print(region_pct_lpg)
}
```


## Examine new weights from Rake 7

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 7",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_7 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 7)

# Write the tibble to a CSV file
write_csv(survey_all_weights_7, "rake_7_weights.csv")
```


# RAKE 8

```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, 
                   list(~urban_rural_str+collapsed_region), 
                   list(pop.table_urban_rural)
                   )

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 8

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)


#check out hh structures
svytotal(~hh_water_source, design = trimmed_raked_surv, na.rm = TRUE)

svymean(~house_rooms, design = trimmed_raked_surv, na.rm = TRUE)
```

## loop to find main fuel counts 

```{r, message=FALSE, warning=FALSE}
#obtain a list of the regions
regions <- gss_regional$region

#loop through each of the regions in the list 
for (i in seq_along(regions)){
  
  #subset the raked survey to the region
  region_subset = subset(trimmed_raked_surv, region == regions[i])
  
  #create list of regions populations
  regions_pop <- pop.region_hh[[2]]
  
  #obtain population for specific region in the loop
  region_pop = regions_pop[i]
  
  #get the fuel information for the region
  region_fuel  <- as.data.frame(svytotal(~collapsed_fuel, 
                                         design = region_subset, 
                                         na.rm = TRUE))
  
  #obtain just the LPG total for the region 
  region_lpg <- region_fuel[2,1]
  
  #calculate the percent LPG for the region
  region_pct_lpg <- round((region_lpg/region_pop)*100,1)
  
  #print the result for each
  print(region_pct_lpg)
}
```

## Examine new weights from Rake 8

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 8",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_8 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 8)

# Write the tibble to a CSV file
write_csv(survey_all_weights_8, "rake_8_weights.csv")

```




# Rake 9 ~ starting with equal weights (i.e. don't use GL + FM calculated weights)

```{r, message=FALSE, warning=FALSE}
#specify the initial survey design again
survey_design <- svydesign(id=~eacode, #specify clusters 
                          # fpc= ~fpc, #include finite population correction (GL and FM calculations)
                          # weights= ~weight, #specify the survey weights
                           strata= ~region, #specify the region strata
                           data=full_survey_collapsed)
```

```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, list(~urban_rural_str, ~collapsed_fuel, ~region), list(pop.urban_rural_str, pop.primary_fuel, pop.region_hh), control = list(maxit = 15, epsilon = 1))

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 9

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)
```

## Examine new weights from Rake 9

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 9",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_9 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 9)

# Write the tibble to a CSV file
write_csv(survey_all_weights_9, "rake_9_weights.csv")
```

# Rake 10 ~ starting with equal weights (i.e. don't use GL + FM calculated weights)

```{r, message=FALSE, warning=FALSE}
#specify the initial survey design again
survey_design <- svydesign(id=~eacode, #specify clusters 
                          # fpc= ~fpc, #include finite population correction (GL and FM calculations)
                          # weights= ~weight, #specify the survey weights
                           strata= ~region, #specify the region strata
                           data=full_survey_collapsed)
```

```{r, message=FALSE, warning=FALSE}
raked_surv <- rake(survey_design, list(~urban_rural_str+collapsed_region), list(pop.table_urban_rural))

upper_weight <- mean(weights(raked_surv, type = "sampling")) * 5

trimmed_raked_surv <- trimWeights(raked_surv, lower=0.1, upper=upper_weight,
                                   strict = TRUE)
```

## National Population Results from Rake 10

```{r, message=FALSE, warning=FALSE}
#total population
survey::svytotal(c(rep(1, nrow(full_survey))), trimmed_raked_surv)

#urban/rural totals
svytotal(~urban_rural_str, design = trimmed_raked_surv, na.rm = TRUE)

#region hh populations 
svytotal(~region, design = trimmed_raked_surv, na.rm = TRUE)

#mean hh members
svymean(~total_hh_num, design = trimmed_raked_surv, na.rm = TRUE)

#LPG main stove
svytotal(~collapsed_fuel, design = trimmed_raked_surv)


#URBAN
#urban subset 
urban_sub <- subset(trimmed_raked_surv, urban_rural == 1)

#urban hh size
svymean(~total_hh_num, design = urban_sub, na.rm = TRUE)

#urban LPG primary stove 
svytotal(~collapsed_fuel, design = urban_sub, na.rm = TRUE)


#RURAL
#rural subset
rural_sub <- subset(trimmed_raked_surv, urban_rural == 2)

# rural hh size 
svymean(~total_hh_num, design = rural_sub, na.rm = TRUE)

# rural LPG primary stove
svytotal(~collapsed_fuel, design = rural_sub, na.rm = TRUE)


#Greater Accra LPG
accra_sub <- subset(trimmed_raked_surv, region == "Greater Accra")
svytotal(~collapsed_fuel, design = accra_sub, na.rm = TRUE)

#Ashanti LPG
ashanti_sub <- subset(trimmed_raked_surv, region == "Ashanti")
svytotal(~collapsed_fuel, design = ashanti_sub, na.rm = TRUE)
```

## Examine new weights from Rake 10

```{r, message=FALSE, warning=FALSE}
#Identify new weights from raking process
raked_weights <- weights(trimmed_raked_surv, type = "sampling")

#add new weights to full dataframe
survey_all_weights <- bind_cols(survey_with_weights, raked_weights) %>%
  rename("rake_weight" = "...58") %>%
  mutate(weight_diff = rake_weight - weight,
         weight_ratio = rake_weight / weight)

#graphing the original weights with the comparison
survey_all_weights %>%
  pivot_longer(cols = c(weight, rake_weight), names_to = "Variable", values_to = "Value") %>%
  ggplot(aes(x = Value, fill = Variable)) +
  geom_histogram(bins = 30, position = "identity", alpha = 0.6) +
  labs(title = "Histogram of Weights: Rake 10",
       x = "Survey Weight",
       y = "Frequency",
       fill = "Weight Origin") +
  theme_bw() +
  scale_fill_manual(values = c("rake_weight" = "#a8605d", 
                               "weight" = "#7fabc7"),
                    labels = c("rake_weight" = "Raked Weight", 
                               "weight" = "Original Weights")) 

#create df with hh_id and weights to be exported
survey_all_weights_10 <- survey_all_weights %>% select(hh_id, rake_weight) %>%
  mutate(rake_method = 10)

# Write the tibble to a CSV file
write_csv(survey_all_weights_10, "rake_10_weights.csv")
```




# Joining all the weights together

```{r, message=FALSE, warning=FALSE}
#bind all the dataframe together
all_rake_weights <- bind_rows(survey_all_weights_1, survey_all_weights_2, survey_all_weights_3, survey_all_weights_4, survey_all_weights_5b, survey_all_weights_7, survey_all_weights_8, survey_all_weights_9, survey_all_weights_10)

#reformat data 
all_rake_weights_wide <- all_rake_weights %>%
  pivot_wider(names_from = rake_method, values_from = rake_weight, names_prefix = "rake_method_")

# Write to a CSV file
write_csv(all_rake_weights_wide, "full_rake_weights_GL.csv")
```


